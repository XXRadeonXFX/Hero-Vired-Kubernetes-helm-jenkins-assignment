pipeline {
  agent any

  environment {
    DOCKERHUB_CREDENTIALS = credentials('DOCKER-PRINCE-CRED')
    BACKEND_IMAGE  = "xxradeonxfx/learner-backend:latest"
  }

  stages {
    stage('Clone Repo') {
      steps {
        git branch: 'main', url: 'https://github.com/UnpredictablePrashant/learnerReportCS_backend'
      }
    }

    stage('Build Backend Docker Image') {
      steps {
        sh "docker build -t $BACKEND_IMAGE ."
      }
    }

    stage('Push Docker Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'DOCKER-PRINCE-CRED', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          sh """
            echo \$PASSWORD | docker login -u \$USERNAME --password-stdin
            docker push $BACKEND_IMAGE
          """
        }
      }
    }

    stage('Deploy via Helm') {
      steps {
        dir('helm') {
          sh "helm upgrade --install mern ./mern-chart --set backend.image=$BACKEND_IMAGE --namespace default"
        }
      }
    }
  }

  post {
    success {
      echo '✅ Backend Deployment Successful!'
    }
    failure {
      echo '❌ Build Failed!'
    }
  }
}
